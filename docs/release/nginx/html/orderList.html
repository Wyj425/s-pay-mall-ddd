<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>我的订单 - 拼多多</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:"PingFang SC","Helvetica Neue",Arial,sans-serif;-webkit-tap-highlight-color:transparent;}
        body{background:#f5f5f5;color:#333;font-size:14px;line-height:1.5;overflow-x:hidden;}
        .page{max-width:750px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;}
        .header{position:sticky;top:0;background:linear-gradient(90deg,#ff5000,#ff2c2c);color:#fff;padding:12px 12px 10px;z-index:10;}
        .header-bar{display:flex;align-items:center;gap:8px;}
        .back-btn{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;color:#fff;cursor:pointer;}
        .title{font-size:18px;font-weight:700;margin-left:4px;}
        .tabs{display:flex;background:#fff;border-bottom:1px solid #eee;}
        .tab{flex:1;text-align:center;padding:10px 0;cursor:pointer;color:#666;position:relative;}
        .tab.active{color:#ff2c2c;font-weight:700;}
        .tab.active::after{content:"";position:absolute;left:25%;right:25%;bottom:0;height:2px;background:#ff2c2c;border-radius:2px;}
        .list{flex:1;padding:10px 10px 70px;}
        .card{background:#fff;border-radius:10px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,0.04);border:1px solid #f3f3f3;overflow:hidden;}
        .card-hd{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px dashed #f0f0f0;}
        .shop-name{font-weight:700;color:#333;}
        .status-badge{font-size:12px;padding:2px 8px;border-radius:12px;}
        .s-wait{background:#fff0e8;color:#ff5000;border:1px solid #ffd9cc;}
        .s-success{background:#eaffea;color:#2fab2f;border:1px solid #c9efcb;}
        .s-closed{background:#f0f0f0;color:#999;border:1px solid #e5e5e5;}
        .card-bd{display:flex;gap:10px;padding:12px;}
        .thumb{width:72px;height:72px;border-radius:8px;background:#fafafa url('images/img1.png') center/cover no-repeat;border:1px solid #f3f3f3;flex:0 0 auto;}
        .info{flex:1;display:flex;flex-direction:column;gap:4px;}
        .name{font-weight:700;color:#333;}
        .meta{color:#888;font-size:12px;}
        .amount{color:#ff2c2c;font-weight:700;}
        .amount::before{content:"¥";font-weight:700;}
        .card-ft{display:flex;justify-content:flex-end;gap:10px;padding:10px;border-top:1px dashed #f0f0f0;background:#fff;}
        .btn{height:32px;padding:0 12px;border-radius:16px;border:1px solid #ddd;background:#fff;color:#333;cursor:pointer;}
        .btn-red{border:none;background:linear-gradient(90deg,#ff5000,#ff2c2c);color:#fff;font-weight:700;}
        .btn[disabled]{opacity:.6;cursor:not-allowed;}
        .footer-tip{padding:14px 0;color:#999;text-align:center;font-size:12px;}
        .float-tools{position:fixed;right:14px;bottom:90px;display:flex;flex-direction:column;gap:10px;}
        .float-btn{width:42px;height:42px;border-radius:50%;background:#fff;box-shadow:0 6px 16px rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid #f0f0f0;}
        .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);color:#fff;padding:8px 14px;border-radius:4px;font-size:13px;display:none;z-index:999;}
    </style>
    <script src="js/common.js"></script>
</head>
<body>
<div class="page">
    <div class="header">
        <div class="header-bar">
            <div class="back-btn" id="backBtn">←</div>
            <div class="title">我的订单</div>
        </div>
    </div>

    <div class="tabs" id="tabs">
        <div class="tab active" data-status="ALL">全部</div>
        <div class="tab" data-status="UNPAID">未支付</div>
        <div class="tab" data-status="PAID">已支付</div>
        <div class="tab" data-status="CLOSED">已关闭</div>
    </div>

    <div class="list" id="list"></div>
    <div class="footer-tip" id="footerTip">下拉加载更多</div>

    <div class="float-tools">
        <div class="float-btn" id="toTopBtn">↑</div>
        <div class="float-btn" id="refreshBtn">⟳</div>
    </div>

    <div class="toast" id="toast"></div>
</div>

<script>
    const sPayMallUrl = AppConfig.sPayMallUrl;

    // 工具
    function getCookie(name){
        const m=document.cookie.match(new RegExp("(^| )"+name+"=([^;]+)"));
        return m?decodeURIComponent(m[2]):null;
    }
    function showToast(msg){
        const t=document.getElementById('toast');
        t.innerText=msg; t.style.display='block';
        setTimeout(()=>t.style.display='none',1800);
    }
    function fmtAmount(n){ if(n==null) return '0.00'; const v=Number(n); return v.toFixed(2); }
    function fmtTime(iso){
        if(!iso) return '--';
        try{
            const d=new Date(iso);
            const y=d.getFullYear();
            const M=String(d.getMonth()+1).padStart(2,'0');
            const D=String(d.getDate()).padStart(2,'0');
            const h=String(d.getHours()).padStart(2,'0');
            const m=String(d.getMinutes()).padStart(2,'0');
            const s=String(d.getSeconds()).padStart(2,'0');
            return `${y}-${M}-${D} ${h}:${m}:${s}`;
        }catch(e){ return iso; }
    }

    // 状态映射（服务端 → 展示）
    function statusInfo(serverStatus){
        switch(serverStatus){
            case 'CREATE':     return {cls:'s-wait',    text:'创建完成（待支付）', group:'UNPAID'};
            case 'PAY_WAIT':   return {cls:'s-wait',    text:'等待支付',          group:'UNPAID'};
            case 'PAY_SUCCESS':return {cls:'s-success', text:'支付成功，等待拼团完成', group:'PAID'};
            case 'DEAL_DONE':  return {cls:'s-success', text:'拼团完成，等待发货',   group:'PAID'};
            case 'CLOSE':      return {cls:'s-closed',  text:'订单已关闭',        group:'CLOSED'};
            default:           return {cls:'s-closed',  text:serverStatus||'--', group:'OTHER'};
        }
    }

    // 页面状态
    let currentFilter='ALL';
    let items=[];
    let lastId=0;
    let hasMore=true;
    let isLoading=false;

    const listEl = document.getElementById('list');
    const footerTip = document.getElementById('footerTip');

    // 渲染
    function render(){
        listEl.innerHTML='';
        const filtered = items.filter(it=>{
            const si = statusInfo(it.status);
            if(currentFilter==='ALL') return true;
            if(currentFilter==='UNPAID') return si.group==='UNPAID';
            if(currentFilter==='PAID')   return si.group==='PAID';
            if(currentFilter==='CLOSED') return si.group==='CLOSED';
            return true;
        });

        if(filtered.length===0){
            listEl.innerHTML = `<div style="color:#999;text-align:center;padding:30px 0;">暂无订单</div>`;
        }else{
            filtered.forEach(it=>{
                const si = statusInfo(it.status);
                const card = document.createElement('div');
                card.className='card';

                // 底部按钮：未关闭都可“取消订单”；未支付多一个“立即支付”
                let footerBtns = '';
                if (si.group === 'UNPAID') {
                    footerBtns = `
                        <button class="btn btn-cancel">取消订单</button>
                        <button class="btn btn-red pay-now">立即支付</button>
                    `;
                } else if (si.group === 'PAID') {
                    footerBtns = `
                        <button class="btn btn-cancel">取消订单</button>
                        <button class="btn btn-rebuy">再次购买</button>
                    `;
                } else { // CLOSED
                    footerBtns = `<button class="btn btn-rebuy">再次购买</button>`;
                }

                card.innerHTML=`
                    <div class="card-hd">
                      <div class="shop-name">拼多多自营</div>
                      <div class="status-badge ${si.cls}">${si.text}</div>
                    </div>
                    <div class="card-bd">
                      <div class="thumb"></div>
                      <div class="info">
                        <div class="name">${escapeHtml(it.productName || '商品')}</div>
                        <div class="meta">订单号：${it.orderId || '--'}</div>
                        <div class="meta">下单时间：${fmtTime(it.orderTime)}</div>
                        <div class="meta">优惠：¥${fmtAmount(it.marketDeductionAmount || 0)}</div>
                        <div class="meta">应付：<span class="amount">${fmtAmount(it.payAmount ?? it.totalAmount ?? 0)}</span></div>
                      </div>
                    </div>
                    <div class="card-ft">
                      ${footerBtns}
                    </div>
                `;

                // 立即支付
                const payBtn = card.querySelector('.pay-now');
                if(payBtn){
                    payBtn.addEventListener('click', ()=> submitPayForm(it.payUrl));
                }

                // 取消订单：只要不是 close 都允许点
                const cancelBtn = card.querySelector('.btn-cancel');
                if(cancelBtn && si.group!=='CLOSED'){
                    cancelBtn.addEventListener('click', ()=> refundOrder(it, cancelBtn));
                }

                const rebuyBtn = card.querySelector('.btn-rebuy');
                if(rebuyBtn){
                    rebuyBtn.addEventListener('click', ()=> showToast('演示环境：未接入再次购买'));
                }

                listEl.appendChild(card);
            });
        }
        footerTip.innerText = hasMore ? '下拉加载更多' : '没有更多了';
    }

    async function refundOrder(order, btnEl){
        if (!confirm('确定要取消该订单吗？')) return;

        const userId = getCookie('loginToken');
        const orderId = order.orderId;
        if (!userId || !orderId) {
            showToast('订单信息缺失，无法取消');
            return;
        }
        const url = sPayMallUrl + "/api/v1/alipay/refund_order";
        const headers = {
            "Accept":"*/*",
            "Accept-Encoding":"gzip, deflate, br",
            "Connection":"keep-alive",
            "Content-Type":"application/json",
            "User-Agent":"PostmanRuntime-ApipostRuntime/1.1.0"
        };
        const body = { userId, orderId };

        const prev = btnEl.innerText;
        btnEl.innerText = '取消中...';
        btnEl.disabled = true;
        try{
            const res = await fetch(url,{method:'POST',headers,body:JSON.stringify(body)});
            const data = await res.json();
            if(data && data.code==='0000' && data.data && data.data.success){
                showToast(data.data.message || '取消成功');
                // 强制重新拉取，确保状态持久
                forceReload();
            }else{
                showToast((data && (data.data?.message || data.info)) || '取消失败');
                btnEl.innerText = prev; btnEl.disabled = false;
            }
        }catch(e){
            showToast('网络异常，取消失败');
            btnEl.innerText = prev; btnEl.disabled = false;
        }
    }

    function submitPayForm(html){
        if(!html){ showToast('未获取到支付链接'); return; }
        const div=document.createElement('div');
        div.innerHTML=html;
        const form = div.querySelector('form');
        if(form){ document.body.appendChild(div); form.submit(); }
        else{ showToast('支付链接异常'); }
    }
    function escapeHtml(str){
        return String(str || '').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    // 拉取订单（所有 Tab 都从服务端取）
    async function fetchOrders(nextId=0, pageSize=10){
        if(isLoading || !hasMore) return;
        isLoading=true; footerTip.innerText='加载中...';

        const userId = getCookie('loginToken');
        if(!userId){ window.location.href='login.html'; return; }

        const url = sPayMallUrl + "/api/v1/alipay/query_user_order_list";
        const headers = {
            "Accept":"*/*",
            "Accept-Encoding":"gzip, deflate, br",
            "Connection":"keep-alive",
            "Content-Type":"application/json",
            "User-Agent":"PostmanRuntime-ApipostRuntime/1.1.0"
        };
        const body = { userId, lastId: nextId, pageSize };

        try{
            const res = await fetch(url, { method:'POST', headers, body: JSON.stringify(body) });
            const data = await res.json();
            if(data && data.code==='0000'){
                const dl = (data.data && data.data.orderList) || [];
                items = items.concat(dl);
                lastId = (data.data && data.data.lastId) || lastId;
                hasMore = !!(data.data && data.data.hasMore);
                render();
            }else{
                showToast((data && data.info) || '加载失败');
            }
        }catch(e){
            showToast('网络异常，请稍后重试');
        }finally{
            isLoading=false;
            footerTip.innerText = hasMore ? '下拉加载更多' : '没有更多了';
        }
    }

    function forceReload(){
        items=[]; lastId=0; hasMore=true; isLoading=false;
        listEl.innerHTML=''; footerTip.innerText='加载中...';
        fetchOrders(0);
    }

    // 事件
    document.getElementById('backBtn').addEventListener('click', ()=> history.back());
    document.getElementById('toTopBtn').addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
    document.getElementById('refreshBtn').addEventListener('click', forceReload);

    window.addEventListener('scroll', ()=>{
        const nearBottom = window.innerHeight + window.scrollY >= (document.body.offsetHeight - 100);
        if(nearBottom) fetchOrders(lastId);
    });

    document.querySelectorAll('.tab').forEach(tab=>{
        tab.addEventListener('click', ()=>{
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            currentFilter = tab.dataset.status || 'ALL';
            forceReload(); // 切换任何 Tab 都重新从服务端获取
        });
    });

    // 启动
    (function init(){
        if(!getCookie('loginToken')){ window.location.href='login.html'; return; }
        forceReload();
    })();
</script>
</body>
</html>
