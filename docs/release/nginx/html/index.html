<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>炎帝拼装合金骨架模型 - 拼多多</title>
    <style>
        /* 基础样式 */
        * {margin:0;padding:0;box-sizing:border-box;font-family:"PingFang SC","Helvetica Neue",Arial,sans-serif;-webkit-tap-highlight-color:transparent;}
        body {background-color:#f5f5f5;color:#333;font-size:14px;line-height:1.5;overflow-x:hidden;}
        .container {max-width:750px;margin:0 auto;background:white;min-height:100vh;position:relative;padding-bottom:60px;}

        /* Swiper 样式 */
        .swiper-container {width:100%;height:375px;position:relative;overflow:hidden;}
        .swiper-wrapper {display:flex;transition:transform 0.3s ease;height:100%;}
        .swiper-slide {flex:0 0 100%;height:100%;background-size:cover;background-position:center;}
        .swiper-pagination {position:absolute;bottom:15px;left:0;right:0;display:flex;justify-content:center;}
        .swiper-pagination-bullet {width:6px;height:6px;border-radius:50%;background-color:rgba(255,255,255,0.5);margin:0 3px;cursor:pointer;}
        .swiper-pagination-bullet-active {background-color:#ff5000;}

        /* 产品信息样式 */
        .product-info {padding:15px;background:white;position: relative;}
        .price-tag {background:linear-gradient(90deg,#fff7f7,#fff2f2);border-radius:4px;padding:4px 8px;color:#ff5000;font-size:12px;display:inline-flex;align-items:center;}
        .price-tag span {font-weight:bold;margin-left:4px;}
        .product-title {font-size:18px;font-weight:bold;margin:10px 0;line-height:1.4;}
        .activity-tag {display:inline-block;background:linear-gradient(90deg,#ff5000,#ff2c2c);color:white;font-size:12px;padding:2px 6px;border-radius:2px;margin-right:8px;}
        .promo-info {color:#ff5000;font-size:13px;margin:8px 0;}
        .price-section {display:flex;align-items:flex-end;margin:12px 0;}
        .current-price {color:#ff5000;font-size:24px;font-weight:bold;}
        .current-price::before {content:"¥";font-size:18px;}
        .original-price {color:#999;font-size:14px;text-decoration:line-through;margin-left:8px;}

        /* 抢购人数样式 */
        .user-count-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(90deg, #ff5000, #ff2c2c);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(255,80,0,0.2);
            z-index: 10;
        }

        /* 拼团信息样式 */
        .group-section {background:#fef6f5;border-radius:8px;padding:12px 15px;margin-top:15px;border:1px solid #ffefe4;}
        .section-title {font-size:16px;font-weight:bold;margin-bottom:12px;display:flex;justify-content:space-between;}
        .group-count {font-size:13px;color:#999;font-weight:normal;}
        .group-list {display:flex;flex-direction:column;gap:12px;}
        .group-item {background:white;border-radius:8px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,0.04);position:relative;border:1px solid #ffefe4;display:flex;align-items:center;justify-content:space-between;}
        .group-leader {display:flex;align-items:center;flex:1;}
        .avatar {width:36px;height:36px;border-radius:50%;color:white;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;margin-right:10px;background-color:#ff5000;}
        .leader-name {font-weight:bold;font-size:14px;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .group-info {flex:2;display:flex;flex-direction:column;align-items:flex-start;padding:0 10px;}
        .group-status {font-size:13px;color:#666;margin-bottom:4px;}
        .remaining {color:#ff5000;font-weight:bold;}
        .countdown {background:#fff0e8;color:#ff5000;font-size:12px;padding:4px 8px;border-radius:4px;display:inline-block;}
        .group-btn {height:34px;padding:0 15px;background:linear-gradient(90deg,#ff5000,#ff2c2c);color:white;border:none;border-radius:17px;font-size:14px;font-weight:bold;cursor:pointer;white-space:nowrap;}

        /* 底部操作栏样式（含“我的订单”） */
        .action-bar {position:fixed;bottom:0;left:0;right:0;height:50px;background:white;display:flex;border-top:1px solid #eee;max-width:750px;margin:0 auto;z-index:100;}
        .action-btn {flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;color:#666;cursor:pointer;gap:2px;}
        .action-btn i {font-style:normal;font-size:16px;line-height:1;}
        .buy-btn {flex:2;background:#ffd84d;color:#333;font-weight:bold;font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
        .group-buy-btn {flex:3;background:linear-gradient(90deg,#ff5000,#ff2c2c);color:white;font-weight:bold;font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;}

        /* 弹窗与 Toast */
        .overlay {display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999;}
        .toast {position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:10px 20px;border-radius:4px;font-size:14px;z-index:1001;display:none;}

        /* 支付模态框 */
        .payment-modal {display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:300px;padding:30px 20px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,0.1);border-radius:12px;z-index:1001;text-align:center;}
        .pay-title {font-size:20px;font-weight:bold;margin-bottom:10px;}
        .pay-amount {color:#666;font-size:16px;margin-bottom:12px;}

        /* 新增：测试账号展示与复制按钮 */
        .alipay-test {display:flex;align-items:center;justify-content:center;gap:8px;color:#666;font-size:14px;flex-wrap:wrap;margin-bottom:8px;}
        .alipay-test .value {font-weight:bold;color:#333;}
        .copy-btn {padding:3px 8px;border:1px solid #ddd;background:#f7f7f7;border-radius:6px;cursor:pointer;font-size:12px;}
        .copy-btn:active {background:#e9e9e9;}

        .pay-options {display:flex;flex-direction:column;gap:15px;margin-top:25px;}
        .pay-option-btn {width:100%;height:45px;font-size:16px;border-radius:8px;border:1px solid #eee;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:bold;transition:background-color 0.2s,border-color 0.2s;}
        .wechat-pay-btn {background-color:#06a020;color:white;border-color:#06a020;}
        .wechat-pay-btn:active {background-color:#058a1b;}
        .alipay-pay-btn {background-color:#1677ff;color:white;border-color:#1677ff;}
        .alipay-pay-btn:active {background-color:#1366e0;}
        .cancel-pay-btn {background-color:#f0f0f0;color:#333;border-color:#ccc;}
        .cancel-pay-btn:active {background-color:#e0e0e0;}

        /* 二维码显示区域 */
        .qrcode-display {display:none;}
        .qrcode-container {width:180px;height:180px;margin:20px auto;border:1px solid #eee;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;background-color:white;}
        .qrcode-container img {width:100%;height:100%;object-fit:cover;}
        .qrcode-display .pay-cancel {margin-top:20px;width:100%;height:40px;font-size:14px;border-radius:8px;border:1px solid #ccc;background:#f0f0f0;color:#333;cursor:pointer;}
        .qrcode-display .pay-cancel:active {background-color:#e0e0e0;}

        /* 错误提示模态框 */
        .error-modal {display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:300px;padding:30px 20px;background:#fff;box-shadow:0 8px 25px rgba(0,0,0,0.15);border-radius:12px;z-index:1001;text-align:center;border-top:5px solid #ff3c00;}
        .error-icon {font-size:48px;color:#ff3c00;margin-bottom:15px;}
        .error-title {font-size:22px;font-weight:bold;margin-bottom:10px;color:#333;}
        .error-message {color:#666;font-size:16px;line-height:1.5;margin-bottom:25px;padding:0 10px;}
        .error-close-btn {width:100%;height:45px;font-size:16px;border-radius:8px;border:none;background:linear-gradient(90deg,#ff5000,#ff2c2c);color:white;font-weight:bold;cursor:pointer;transition:all 0.2s;}
        .error-close-btn:active {background:linear-gradient(90deg,#ff3c00,#ff1c00);transform:translateY(2px);}
    </style>
    <script src="js/common.js"></script>
</head>
<body>
<div class="container" id="productPage">
    <!-- 抢购人数徽章 -->
    <div class="user-count-badge" id="userCountBadge" style="display:none;">
        <span id="userCountNum">0</span>人正在抢
    </div>

    <div class="swiper-container">
        <div class="swiper-wrapper">
            <div class="swiper-slide" style="background-image:url('images/img1.png')"></div>
            <div class="swiper-slide" style="background-image:url('images/img2.png')"></div>
            <div class="swiper-slide" style="background-image:url('images/img3.png')"></div>
        </div>
        <div class="swiper-pagination">
            <div class="swiper-pagination-bullet"></div>
            <div class="swiper-pagination-bullet"></div>
            <div class="swiper-pagination-bullet"></div>
        </div>
    </div>

    <div class="product-info">
        <div class="price-tag" id="priceTag">百亿补贴 <span>直降¥0</span></div>
        <h1 class="product-title">炎帝拼装合金骨架模型：豪华版</h1>
        <div class="promo-info" id="promoInfo"><span class="activity-tag">百亿补贴</span>限量优惠，即将抢光！</div>
        <div class="price-section">
            <div class="current-price" id="currentPrice">0</div>
            <div class="original-price" id="originalPrice">¥0</div>
        </div>

        <div class="group-section" id="groupSection">
            <div class="section-title">正在拼团中 <span class="group-count">拼单成功可返20元红包</span></div>
            <div class="group-list" id="groupList"></div>
        </div>
    </div>

    <div class="action-bar">
        <div class="action-btn" id="collectBtn"><i>❤️</i><span>收藏</span></div>
        <div class="action-btn" id="cartBtn"><i>🛒</i><span>购物车</span></div>
        <div class="action-btn" id="orderBtn"><i>📦</i><span>我的订单</span></div>
        <div class="action-btn" id="serviceBtn"><i>👤</i><span>客服</span></div>
        <div class="buy-btn" id="buyAlone">单独购买 ¥0</div>
        <div class="group-buy-btn" id="startGroup">发起拼团 ¥0</div>
    </div>
</div>

<div class="overlay" id="payOverlay"></div>
<div class="payment-modal" id="paymentModal">
    <h2 class="pay-title">选择支付方式</h2>
    <p class="pay-amount">支付金额 ¥<span id="payAmount">0</span></p>

    <!-- 替换订单号：展示支付宝测试账号 + 复制按钮 -->
    <div class="alipay-test">
        <span>支付宝测试账号：</span>
        <span class="value" id="alipayTestAccount">sltkvv0490@sandbox.com</span>
        <button class="copy-btn" id="copyAlipayAccountBtn">复制</button>
    </div>

    <div class="pay-options" id="payOptions">
        <button class="pay-option-btn wechat-pay-btn" id="wechatPayBtn">微信支付</button>
        <button class="pay-option-btn alipay-pay-btn" id="alipayPayBtn">支付宝支付</button>
        <button class="pay-option-btn cancel-pay-btn" id="cancelPayBtn">取消支付</button>
    </div>

    <div class="qrcode-display" id="wechatQrcodeDisplay">
        <div class="qrcode-container">
            <img src="images/img4.png" alt="微信支付二维码" />
        </div>
        <p style="color:#666;font-size:12px;margin-top:10px;">请使用微信扫码支付</p>
        <button class="pay-cancel" id="backToOptionsBtn">返回选择</button>
    </div>
</div>

<!-- 错误提示模态框 -->
<div class="error-modal" id="errorModal">
    <div class="error-icon">⚠️</div>
    <h2 class="error-title">操作失败</h2>
    <p class="error-message" id="errorMessage">发生未知错误，请稍后再试</p>
    <button class="error-close-btn" id="errorCloseBtn">知道了</button>
</div>

<div class="toast" id="toast"></div>

<script>
    // 读取 AppConfig
    const sPayMallUrl = AppConfig.sPayMallUrl;
    const groupBuyMarketUrl = AppConfig.groupBuyMarketUrl;
    const goodsId = AppConfig.goodsId;

    // 登录校验
    if (!getCookie("loginToken")) {
        window.location.href = "login.html";
    }

    function getCookie(name) {
        const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
        return match ? decodeURIComponent(match[2]) : null;
    }

    function showToast(message) {
        const toast = document.getElementById("toast");
        toast.innerText = message;
        toast.style.display = "block";
        setTimeout(() => (toast.style.display = "none"), 2000);
    }

    function showErrorModal(message) {
        document.getElementById("errorMessage").innerText = message;
        document.getElementById("errorModal").style.display = "block";
        document.getElementById("payOverlay").style.display = "block";
    }
    function hideErrorModal() {
        document.getElementById("errorModal").style.display = "none";
        document.getElementById("payOverlay").style.display = "none";
    }

    let goods = {};
    let activityId = 0;
    let alipayFormHtml = '';
    const ALIPAY_TEST_ACCOUNT = 'sltkvv0490@sandbox.com';

    function showPaymentModal() {
        document.getElementById("payOverlay").style.display = "block";
        document.getElementById("paymentModal").style.display = "block";
        document.getElementById("payOptions").style.display = "flex";
        document.getElementById("wechatQrcodeDisplay").style.display = "none";
    }
    function hidePaymentModal() {
        document.getElementById("payOverlay").style.display = "none";
        document.getElementById("paymentModal").style.display = "none";
    }

    function startCountdown(element, seconds) {
        function update() {
            if (seconds <= 0) { element.innerText = "已结束"; return; }
            let h = Math.floor(seconds / 3600);
            let m = Math.floor((seconds % 3600) / 60);
            let s = seconds % 60;
            element.innerText = h > 0
                ? `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`
                : `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            seconds--;
            setTimeout(update, 1000);
        }
        update();
    }

    async function lockOrder(teamId = '', isAlone = false) {
        const userId = getCookie("loginToken");
        if (!userId) { window.location.href = "login.html"; return; }

        const url = sPayMallUrl+"/api/v1/alipay/create_pay_order";
        const headers = {
            "Accept": "*/*",
            "Accept-Encoding": "gzip, deflate, br",
            "Connection": "keep-alive",
            "Content-Type": "application/json",
            "User-Agent": "PostmanRuntime-ApipostRuntime/1.1.0"
        };

        let bodyData = isAlone
            ? { userId, productId: goods.goodsId, marketType: 0 }
            : { userId, productId: goods.goodsId, teamId, activityId, marketType: 1 };

        try {
            const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(bodyData) });
            const result = await res.json();
            if (result.code !== "0000") { showErrorModal(result.info || "下单失败，请重试"); return; }

            // 不再展示订单号
            alipayFormHtml = result.data?.alipayForm || result.data;
            const priceToDisplay = isAlone ? goods.originalPrice : goods.payPrice;
            document.getElementById("payAmount").innerText = priceToDisplay;

            // 确保展示测试账号
            document.getElementById("alipayTestAccount").innerText = ALIPAY_TEST_ACCOUNT;

            showPaymentModal();
        } catch (e) {
            showErrorModal("网络请求失败，请检查网络连接");
        }
    }

    // 我的订单：点击先请求并缓存，再跳转
    document.getElementById("orderBtn").addEventListener("click", async () => {
        const userId = getCookie("loginToken");
        if (!userId) { window.location.href = "login.html"; return; }

        const url = sPayMallUrl+"/api/v1/alipay/query_user_order_list";
        const headers = {
            "Accept": "*/*",
            "Accept-Encoding": "gzip, deflate, br",
            "Connection": "keep-alive",
            "Content-Type": "application/json",
            "User-Agent": "PostmanRuntime-ApipostRuntime/1.1.0"
        };
        const body = { userId, lastId: 0, pageSize: 10 };

        try {
            const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
            const result = await res.json();
            if (result && result.code === "0000") {
                sessionStorage.setItem("orderListCache", JSON.stringify(result.data || {}));
            } else {
                sessionStorage.removeItem("orderListCache");
            }
        } catch (e) {
            sessionStorage.removeItem("orderListCache");
        } finally {
            window.location.href = "orderList.html";
        }
    });

    // 购买按钮
    document.getElementById("startGroup").addEventListener("click", () => lockOrder("", false));
    document.getElementById("buyAlone").addEventListener("click", () => lockOrder("", true));

    // 支付模态
    document.getElementById("wechatPayBtn").addEventListener("click", () => {
        document.getElementById("payOptions").style.display = "none";
        document.getElementById("wechatQrcodeDisplay").style.display = "block";
    });
    document.getElementById("alipayPayBtn").addEventListener("click", () => {
        if (alipayFormHtml) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = alipayFormHtml;
            document.body.appendChild(tempDiv);
            const form = tempDiv.querySelector('form');
            if (form) { form.submit(); }
            else { showToast("支付宝支付信息错误，请重试。"); hidePaymentModal(); }
        } else {
            showToast("未能获取支付宝支付信息，请重试。");
            hidePaymentModal();
        }
    });
    document.getElementById("cancelPayBtn").addEventListener("click", hidePaymentModal);
    document.getElementById("backToOptionsBtn").addEventListener("click", () => {
        document.getElementById("wechatQrcodeDisplay").style.display = "none";
        document.getElementById("payOptions").style.display = "flex";
    });
    document.getElementById("errorCloseBtn").addEventListener("click", hideErrorModal);

    // 新增：复制测试账号
    document.getElementById("copyAlipayAccountBtn").addEventListener("click", async () => {
        try {
            await navigator.clipboard.writeText(ALIPAY_TEST_ACCOUNT);
            showToast("已复制：" + ALIPAY_TEST_ACCOUNT);
        } catch (err) {
            // 兼容旧浏览器
            const input = document.createElement('input');
            input.value = ALIPAY_TEST_ACCOUNT;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            showToast("已复制：" + ALIPAY_TEST_ACCOUNT);
        }
    });

    // 初始化
    document.addEventListener("DOMContentLoaded", async () => {
        const res = await fetch(groupBuyMarketUrl+"/api/v1/gbm/index/query_group_buy_market_config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                userId: getCookie("loginToken") || "xfg01",
                source: "s01",
                channel: "c01",
                goodsId: goodsId
            })
        });
        const result = await res.json();
        if (result.code !== "0000") { return showToast(result.info || "数据加载失败"); }

        goods = result.data.goods;
        activityId = result.data.activityId;

        document.getElementById("priceTag").innerHTML = `百亿补贴 <span>直降¥${goods.deductionPrice}</span>`;
        document.getElementById("originalPrice").innerText = `¥${goods.originalPrice}`;
        document.getElementById("currentPrice").innerText = goods.payPrice;
        document.getElementById("buyAlone").innerText = `单独购买 ¥${goods.originalPrice}`;
        document.getElementById("startGroup").innerText = `发起拼团 ¥${goods.payPrice}`;

        if (result.data.teamStatistic && result.data.teamStatistic.allTeamUserCount) {
            const userCount = result.data.teamStatistic.allTeamUserCount;
            document.getElementById("userCountNum").innerText = userCount;
            document.getElementById("userCountBadge").style.display = "block";
        }

        const groupList = document.getElementById("groupList");
        const teamList = result.data.teamList || [];
        groupList.innerHTML = "";
        if (teamList.length === 0) {
            groupList.innerHTML = '<p style="color:#999;text-align:center;padding:15px;">暂无人购买，快来发起拼团吧！</p>';
        } else {
            teamList.slice(0, 3).forEach(team => {
                const remain = team.targetCount - team.lockCount;
                const card = document.createElement("div");
                card.className = "group-item";
                card.innerHTML = `
                    <div class="group-leader">
                      <div class="avatar">${team.userId.slice(-2)}</div>
                      <div class="leader-name">${team.userId}</div>
                    </div>
                    <div class="group-info">
                      <div class="group-status">还差<span class="remaining">${remain}</span>人成团</div>
                      <div class="countdown">加载中...</div>
                    </div>
                    <button class="group-btn">去拼团</button>
                `;
                const countdownEl = card.querySelector(".countdown");
                const parts = team.validTimeCountdown.split(":");
                const seconds = parseInt(parts[0], 10) * 3600 + parseInt(parts[1], 10) * 60 + parseInt(parts[2], 10);
                startCountdown(countdownEl, seconds);
                card.querySelector(".group-btn").addEventListener("click", () => lockOrder(team.teamId, false));
                groupList.appendChild(card);
            });
        }

        // 轮播
        let currentSlide = 0;
        const slides = document.querySelectorAll('.swiper-slide');
        const totalSlides = slides.length;
        const swiperWrapper = document.querySelector('.swiper-wrapper');
        const paginationBullets = document.querySelectorAll('.swiper-pagination-bullet');

        function updateSwiper() {
            swiperWrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
            paginationBullets.forEach((b,i)=> b.classList.toggle('swiper-pagination-bullet-active', i===currentSlide));
        }
        setInterval(()=>{ currentSlide=(currentSlide+1)%totalSlides; updateSwiper(); },3000);
        paginationBullets.forEach((b,i)=> b.addEventListener('click',()=>{ currentSlide=i; updateSwiper(); }));
        updateSwiper();
    });
</script>
</body>
</html>
